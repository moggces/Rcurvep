---
title: "Practical Examples of Using Rcurvep"
author: "Jui-Hua Hsieh"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

Curvep has been extensively used in analyzing concentration-response data (e.g., Tox21 quantitative high throughput screening data). Unlike common concentration-response modeling approaches by fitting data into parametric models such as Hill or logisitic, Curvep is a non-parametric, response noise filtering algorithm based on user-defined thresholds such as the baseline noise threshold and the maximum curve deviation. 

Among thresholds, it is known that the baseline noise threshold (or minimum response threshold) has direct and significant impact on defining activity of testing substances. In high throughput screening, one common method to set the minimum response threshold is using responses in the vehicle control wells. However, in some cases, the minimum response threshold derived from the *vehicle control* responses may not reflect the minimum response requirement for the *testing substances* or it is unclear how to derive a threshold based on *vehicle control* responses distribution (e.g., 3 or 2 standard deviation).

The examples in this document start with cases that the baseline noise threshold is pre-defined and explore cases that baseline noise threshold is unknown.

## Installation

```{r install, eval = FALSE}

# the development version from GitHub:
# install.packages("devtools")
devtools::install_github("moggces/Rcurvep")
devtools::install_github("moggces/Rcurvep", build_vignettes = TRUE)
```


## Examples

```{r loadp, message = FALSE, warning =  FALSE}
# load required packages
library(Rcurvep)
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
```


### Baseline noise threshold is pre-defined

```{r resp}
# load concentration response dataset
data("zfishbeh")
zfishbeh
```

Zebrafish behavior dataset is a dataset with high number of replicates per concentration. Chemicals can induce either hyper-response (increasing) or hypo-response (decreasing). There are `r length(unique(zfishdev$endpoint))` toxicity endpoints, and `r length(unique(zfishdev$chemical))` testing substances in this dataset.  

```{r run_resp, warning = FALSE, message = FALSE}

# a pre-defined threshold for increasing response
threshold_up <- 15
outd <- run_curvep_job(zfishbeh, directionality = 1, n_sample = NULL, threshold = threshold_up, other_paras = list(CARR = 20, TrustHi = TRUE))

# a pred-defined threshold for decreasing response
threshold_down <- 30
outd <- run_curvep_job(zfishbeh, directionality = -1, n_sample = NULL, threshold = threshold_down, other_paras = list(CARR = 20, TrustHi = TRUE))

# or combined
threshold_l <- list("1" = threshold_up, "-1" = threshold_down)
outd <- run_curvep_job(zfishbeh, directionality = 0, n_sample = NULL, threshold = threshold_l, other_paras = list(CARR = 20, TrustHi = TRUE))

```

The `n_sample = NULL` allows to run the calculation based on the original data. If there are multiple responses per concentration, the `median()` value is used to collapse the data. However, the calculation can also be done on the simulated curves. The curves are simulated by bootstraping the replicates per concentration. 

```{r run_resp_boot}

n_sample_test <- 2
outd <- run_curvep_job(zfishbeh, directionality = 1, n_sample = n_sample_test, threshold = 15, other_paras = list(CARR = 20, TrustHi = TRUE))

```

For dataset with low number of replicates per concentration, the curves can be simulated by linearly fit the concentration-response data + random errors bootstrapped from responses in the vehicle control wells. 

```{r run_resp_boot_veh}
error <- rnorm(100, 0, 10)
outd <- run_curvep_job(zfishbeh, directionality = 1, n_sample = 2, threshold = 15, other_paras = list(CARR = 20, TrustHi = TRUE), vehicle_data = error)
```


### Baseline noise threshold is unknown

When baseline noise threshold is unknown, one method is to search possible candidates and the optimal threshold is the lowest threshold that can reduce the variance in potency estimation significantly. The optimal threshold is called as **benchmark response (BMR)** and the potency at the BMR is called as **benchmark concentration (BMC)**. BMC is particularly important for activity estimation in toxicity field since it could be considered the lowest concentration that an effect is observed (or in our case, can be reliably estimated).

```{r run_resp_boot_bmr, warning = FALSE, message = FALSE}

threshold_range <- seq(5, 10, by = 5) # usually seq(5, 95, by = 5)
n_sample_test <- 2 # usually for 1000
outd <- run_curvep_job(zfishbeh, directionality = 1, n_sample = n_sample_test, threshold = threshold_range, other_paras = list(CARR = 20, TrustHi = TRUE))

```


## Output

The output from `run_curvep_job()` contains nested information regarding input, output, and activity. It is easier to use `extract_curvep_data()` to unnest the information. 

### Activity summary

Activity data are generated based on `data(zfishbeh)`.

```{r cal, cache = TRUE}

outd <- run_curvep_job(zfishbeh, directionality = 1, n_sample = 100, threshold = 15, other_paras = list(CARR = 20, TrustHi = TRUE))
```

#### 95% confidence interval and active confidence score

```{r summary_data, message = FALSE, warning = FALSE, dependson = "cal"}

# extract summarized activity
# 95% confidence interval of BMC and hit confidence are calculated
act_sum <- extract_curvep_data(outd, "summary")
act_sum %>% select(-threshold, -concs, -resps, -resps_in)

```

#### Curve plotting using median responses from samples

```{r curve, warning = FALSE, message = FALSE, dependson = "cal", fig.align = "center", fig.width = 6}
 
plotd <- act_sum %>% 
  filter(chemical == "Caffeine|58-08-2") %>%
  unnest() 

p <- ggplot(plotd, aes(x = concs, y = resps)) + geom_point() + geom_line()
p + facet_wrap(~ endpoint)

  
```


## BMR identication

The complete Zebrafish development dataset was processed (up direction), using 1000 simulated curves, threshold from 5% to 95% with 5% increment. 

```{r bmr_notrun, eval = FALSE}
zfishdev_complete # a complete zfishdev dataset; available upon request 

# calculation (not run)
# simplify_out = TRUE to reduce the amount of output
outd <- run_curvep_job(zfishdev_complete, 
                       directionality = 1, n_sample = 1000, 
                       threshold = seq(5, 95, by = 5), 
                       other_paras = list(CARR = 20, TrustHi = TRUE),
                       simplify_output = TRUE)
```

Activity results are put into the function `identify_basenoise_threshold()`. The function uses various methods to identify the *elbow* in the curve of threshold (x-axis) vs pooled_variance (y-axis). The *elbow* is the lowest threshold where variance of potency estimation is sufficiently reduced and even stabilized. 

```{r bmr, warning = FALSE, message = FALSE}

data("zfishdev_act")

acts <- zfishdev_act %>% 
  mutate(POD = ifelse(is.na(POD), conc_highest, POD))

outthres <- identify_basenoise_threshold(acts, endpoint = "endpoint", direction = "direction", chemical = "chemical", threshold = "threshold", potency = "POD", plot = FALSE)

```

We could plot the diagnostic plots by applying the `plot = TRUE`. In the plot of threshold vs pooled variance, the ideal curve should look like *percent_affected_96*. At threshold = 25%, the pooled_variance is stabilized. However, for the endpoint, *percent_mortality_96*, there are not enough response variations in the dataset (i.e., almost all chemicals are **clear inactive**), therefore, we cannot derive the baseline noise threshold for this endpoint in this dataset. 


```{r plot_thres, fig.align = "center", fig.width = 6}

outthres <- identify_basenoise_threshold(acts, endpoint = "endpoint", direction = "direction", chemical = "chemical", threshold = "threshold", potency = "POD", plot = TRUE)


```

Therefore, the thresholds identified are:

```{r opti_thres}

outthres %>% 
  filter(thresCurva == 1 | thresDist == 1) %>%
  select(endpoint, direction, thresCurva, thresDist, threshold)

```

## Prerequisites

1. The baseline of responses is 0. 
2. concentration is in `log10(M)` format. M: molar concentration.





